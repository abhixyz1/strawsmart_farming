rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // ============================================
    // USERS COLLECTION
    // ============================================
    match /users/{userId} {
      // Semua user login bisa baca profile user lain (untuk admin list users)
      allow read: if request.auth != null;
      
      // User hanya bisa update profile sendiri
      allow write: if request.auth.uid == userId;
      
      // Memberships subcollection - relasi user ke greenhouse/device
      match /memberships/{deviceId} {
        // User bisa baca membership sendiri
        allow read: if request.auth.uid == userId;
        
        // Admin atau user sendiri bisa write
        // Untuk production: tambahkan cek role admin
        allow write: if request.auth != null;
      }
    }
    
    // ============================================
    // DEVICES COLLECTION (Greenhouse metadata)
    // ============================================
    match /devices/{deviceId} {
      // Semua user login bisa baca device info
      allow read: if request.auth != null;
      
      // Write hanya untuk user yang login (untuk development)
      // Production: batasi hanya admin
      allow write: if request.auth != null;
      
      // Members subcollection - list user yang punya akses ke device
      match /members/{userId} {
        allow read: if request.auth != null;
        allow write: if request.auth != null;
      }
    }
    
    // ============================================
    // WATERING SCHEDULES COLLECTION
    // ============================================
    match /wateringSchedules/{scheduleId} {
      // User login bisa CRUD jadwal
      allow read, write: if request.auth != null;
    }

    // ============================================
    // CULTIVATION BATCHES COLLECTION (Batch Tanam)
    // ============================================
    match /cultivationBatches/{batchId} {
      // User login bisa CRUD batch
      allow read, write: if request.auth != null;
      
      // Journal subcollection
      match /journal/{entryId} {
        allow read, write: if request.auth != null;
      }
    }

    // ============================================
    // CATCH-ALL (untuk development - hapus di production)
    // ============================================
    // match /{document=**} {
    //   allow read, write: if request.auth != null;
    // }
  }
}
