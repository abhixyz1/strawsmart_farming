rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // ============================================
    // HELPER FUNCTIONS
    // ============================================
    function isAdmin(uid) {
      return exists(/databases/$(database)/documents/users/$(uid)) 
        && get(/databases/$(database)/documents/users/$(uid)).data.role == 'admin';
    }
    
    // ============================================
    // USERS COLLECTION
    // ============================================
    match /users/{userId} {
      // Semua user login bisa baca profile user lain (untuk admin list users)
      allow read: if request.auth != null;
      
      // User hanya bisa update profile sendiri
      allow write: if request.auth.uid == userId;
      
      // Memberships subcollection - relasi user ke greenhouse/device
      match /memberships/{deviceId} {
        // User bisa baca membership sendiri, atau admin bisa baca semua
        allow read: if request.auth != null 
          && (request.auth.uid == userId || isAdmin(request.auth.uid));
        
        // Admin atau user sendiri bisa write
        allow write: if request.auth != null 
          && (request.auth.uid == userId || isAdmin(request.auth.uid));
      }
    }
    
    // ============================================
    // DEVICES COLLECTION (Greenhouse metadata)
    // ============================================
    match /devices/{deviceId} {
      // Semua user login bisa baca device info
      allow read: if request.auth != null;
      
      // Write hanya untuk user yang login (untuk development)
      // Production: batasi hanya admin
      allow write: if request.auth != null;
      
      // Members subcollection - list user yang punya akses ke device
      match /members/{userId} {
        allow read: if request.auth != null;
        allow write: if request.auth != null;
      }
    }
    
    // ============================================
    // WATERING SCHEDULES COLLECTION
    // Struktur: wateringSchedules/{uid}/items/{scheduleId}
    // ============================================
    match /wateringSchedules/{uid} {
      // User bisa akses dokumen schedules miliknya
      allow read, write: if request.auth != null && request.auth.uid == uid;
      
      // Subcollection items - jadwal individual
      match /items/{scheduleId} {
        // Petani bisa CRUD jadwal miliknya sendiri
        allow read, write: if request.auth != null && request.auth.uid == uid;
      }
    }

    // ============================================
    // CULTIVATION BATCHES COLLECTION (Batch Tanam)
    // ============================================
    match /cultivationBatches/{batchId} {
      // User login bisa CRUD batch
      allow read, write: if request.auth != null;
      
      // Journal subcollection
      match /journal/{entryId} {
        allow read, write: if request.auth != null;
      }
    }

    // ============================================
    // CATCH-ALL (untuk development - hapus di production)
    // ============================================
    // match /{document=**} {
    //   allow read, write: if request.auth != null;
    // }
  }
}
